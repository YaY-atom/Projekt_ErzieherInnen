---
title: "R Notebook| Datenanalyse & Datenaufbereitung"
author: "Yusuf Adni Yavuz"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_float: true
    theme: cosmo
    code_folding: hide
---

## Bibliotheken aus Libraries.R verwenden

```{r}
source(here::here("R_Libraries", "Libraries.R")) #here("Ordner1","Dateiname.ext") lädt Bibliotheken
```

## Daten laden
## Daten finden und zuweisen:




## Benefits2019

```{r}
source(here("DateiLader", "DateiLader.R"))

data_benefits  <- Datei_laden(
 pfad = "C:/Users/YAVU061/OneDrive - Bertelsmann Stiftung/[P] Zentrum für Datenmanagement - Data Science Lab/Projektarbeit/Jobmonitor Datensätze/Zusatzleistungen - Wir bieten",
  pattern = "Benefits_2019"
)

db19 <- data_benefits[[1]]



#

#db19
db19 <- db19 %>%
  mutate(across(c(concept, span, span_normalized), as.factor))

summary(db19)
```

## 2019

```{r}
# Beispiel: Analyse der Benefits pro Stellenausschreibung
df <- db19 





# 1. Neue Spalten für spezifische Benefits anlegen (logisch: TRUE/FALSE)
df <- df %>%
  mutate(
    hat_13_monatsgehalt = grepl("Weihnachts_13_Gehalt", span_normalized, ignore.case = TRUE),
    hat_urlaubsgeld = grepl("Urlaubsgeld", span_normalized, ignore.case = TRUE),
    hat_urlaubsgeld_13_monatsgehalt = grepl("Urlaubsgeld_Weihnachts_13_Gehalt",span_normalized,ignore.case = TRUE),
    hat_fortbildung = grepl("Fortbildung|Weiterbildung", concept, ignore.case = TRUE),
    hat_gesundheit = grepl("Gesundheit", span, ignore.case = TRUE),
    hat_wasser = grepl("Wasser|Getränke|Kaffe",concept, ignore.case = TRUE)
  )

# 2. Gruppieren nach posting_id, Zusammenfassung der Benefits pro Ausschreibung
benefits_summary <- df %>%
  group_by(posting_id) %>%
  summarise(
    anzahl_benefits = n(),  # Gesamtanzahl aller Benefits
    hat_13_monatsgehalt = any(hat_13_monatsgehalt),
    hat_urlaubsgeld = any(hat_urlaubsgeld),
    hat_urlaubsgeld_13_monatsgehalt = any(hat_urlaubsgeld_13_monatsgehalt),
    hat_fortbildung = any(hat_fortbildung),
    hat_gesundheit = any(hat_gesundheit),
    hat_wasser = any(hat_wasser)
  )

# 3. Ergebnis anschauen
benefits_summary

summary(benefits_summary)
```


## Auswertung A: Häufigkeit Benefits in Ausschreibungen in 2019

```{r}

# Gesamtanzahl der Stellen berechnen
gesamtanzahl <- nrow(benefits_summary)


benefits_summary_long <- benefits_summary %>%
  select(hat_13_monatsgehalt, hat_urlaubsgeld, hat_urlaubsgeld_13_monatsgehalt, hat_fortbildung, hat_gesundheit, hat_wasser) %>%
  summarise_all(~ sum(.)) %>%
  pivot_longer(cols = everything(), names_to = "Benefit", values_to = "Anzahl") %>%
  mutate(Prozent = (Anzahl / gesamtanzahl) * 100,
         Benefit = fct_reorder(Benefit, Prozent, .desc = TRUE))  # Sortierung hier

ggplot(benefits_summary_long, aes(x = Benefit, y = Prozent)) +
  geom_bar(stat = "identity", fill = "steelblue") +
  geom_text(aes(label = paste0(round(Prozent, 1), "%")), 
            vjust = -0.5, size = 4) +
  theme_minimal() +
  labs(title = "Verteilung ausgewählter Benefits in 2019",
       x = "Benefit",
       y = "Anteil in %") +
  scale_y_continuous(labels = scales::percent_format(scale = 1),
                     expand = expansion(mult = c(0, 0.1)))  # Platz nach oben schaffen


```


## Auswertung B: Verteilung der Anzahl an Benefits pro Stellenausschreibung 2019

```{r}

ggplot(benefits_summary, aes(x = anzahl_benefits)) +
  geom_histogram(binwidth = 1, fill = "steelblue", color = "white") +
  theme_minimal() +
  labs(title = "Anzahl der Benefits pro Stellenausschreibung 2019",
       x = "Benefits pro Stelle", y = "Anzahl Stellen")


```





## 2020

```{r}
source(here("DateiLader", "DateiLader.R"))

data_benefits  <- Datei_laden(
 pfad = "C:/Users/YAVU061/OneDrive - Bertelsmann Stiftung/[P] Zentrum für Datenmanagement - Data Science Lab/Projektarbeit/Jobmonitor Datensätze/Zusatzleistungen - Wir bieten",
  pattern = "Benefits_2020"
)

db20 <- data_benefits[[1]]



#

#db19
db20 <- db20 %>%
  mutate(across(c(concept, span, span_normalized), as.factor))

summary(db20)
```

## Daten filtern und Aufbereiten:2020

```{r}


# Beispiel: Analyse der Benefits pro Stellenausschreibung
df <- db20 





# 1. Neue Spalten für spezifische Benefits anlegen (logisch: TRUE/FALSE)
df <- df %>%
  mutate(
    hat_13_monatsgehalt = grepl("Weihnachts_13_Gehalt", span_normalized, ignore.case = TRUE),
    hat_urlaubsgeld = grepl("Urlaubsgeld", span_normalized, ignore.case = TRUE),
    hat_urlaubsgeld_13_monatsgehalt = grepl("Urlaubsgeld_Weihnachts_13_Gehalt",span_normalized,ignore.case = TRUE),
    hat_fortbildung = grepl("Fortbildung|Weiterbildung", concept, ignore.case = TRUE),
    hat_gesundheit = grepl("Gesundheit", span, ignore.case = TRUE),
    hat_wasser = grepl("Wasser|Getränke|Kaffe",concept, ignore.case = TRUE)
  )

# 2. Gruppieren nach posting_id, Zusammenfassung der Benefits pro Ausschreibung
benefits_summary <- df %>%
  group_by(posting_id) %>%
  summarise(
    anzahl_benefits = n(),  # Gesamtanzahl aller Benefits
    hat_13_monatsgehalt = any(hat_13_monatsgehalt),
    hat_urlaubsgeld = any(hat_urlaubsgeld),
    hat_urlaubsgeld_13_monatsgehalt = any(hat_urlaubsgeld_13_monatsgehalt),
    hat_fortbildung = any(hat_fortbildung),
    hat_gesundheit = any(hat_gesundheit),
    hat_wasser = any(hat_wasser)
  )

# 3. Ergebnis anschauen
benefits_summary

summary(benefits_summary)

```

## Auswertung A: Häufigkeit Benefits in Ausschreibungen in 2020

```{r}

# Gesamtanzahl der Stellen berechnen
gesamtanzahl <- nrow(benefits_summary)


benefits_summary_long <- benefits_summary %>%
  select(hat_13_monatsgehalt, hat_urlaubsgeld, hat_urlaubsgeld_13_monatsgehalt, hat_fortbildung, hat_gesundheit, hat_wasser) %>%
  summarise_all(~ sum(.)) %>%
  pivot_longer(cols = everything(), names_to = "Benefit", values_to = "Anzahl") %>%
  mutate(Prozent = (Anzahl / gesamtanzahl) * 100,
         Benefit = fct_reorder(Benefit, Prozent, .desc = TRUE))  # Sortierung hier

ggplot(benefits_summary_long, aes(x = Benefit, y = Prozent)) +
  geom_bar(stat = "identity", fill = "steelblue") +
  geom_text(aes(label = paste0(round(Prozent, 1), "%")), 
            vjust = -0.5, size = 4) +
  theme_minimal() +
  labs(title = "Verteilung ausgewählter Benefits in 2020",
       x = "Benefit",
       y = "Anteil in %") +
  scale_y_continuous(labels = scales::percent_format(scale = 1),
                     expand = expansion(mult = c(0, 0.1)))  # Platz nach oben schaffen


```

## Auswertung B: Verteilung der Anzahl an Benefits pro Stellenausschreibung

```{r}

ggplot(benefits_summary, aes(x = anzahl_benefits)) +
  geom_histogram(binwidth = 1, fill = "steelblue", color = "white") +
  theme_minimal() +
  labs(title = "Anzahl der Benefits pro Stellenausschreibung 2020",
       x = "Benefits pro Stelle", y = "Anzahl Stellen")


```













## KLDB : Erzieher:Innen

## kldb:
1:finde alle kldb einträge für Berufscode: 8311X → Erzieher*innen 

```{r}
erzieherInnen <- kldb_cc %>%
  filter(kldb_id %in% c(83110:83114))%>%
  group_by(kldb_id) %>%
  summarise(anzahl = n()) %>%
  mutate(prozent = round(100*anzahl/sum(anzahl),2))%>%
  arrange(desc(prozent)) %>%
  

labels()  


erzieherInnen


```

## Visualisierung:
```{r}
plot_codes <- ggplot(erzieherInnen, aes(x = reorder(kldb_id, prozent), y= prozent))+
  geom_col(fill = "steelblue")+
  geom_text(aes(label = paste0(prozent, "%")),
            vjust = -0.3,
            size = 4)+
  scale_x_discrete(labels = c(
   "83111" = "Aushilfe", 
   "83112" = "Fachkraft", 
   "83113" = "Spezialist"
   )) +
  scale_y_continuous(labels = function(x) paste0(x, "%"))+
  labs(
    x = "KLD-Berufsgruppe",
    y = "Prozentanteil",
    title = "Erzieher:innen - Verteilung nach KLD-Berufsgruppen im Jahre 2024"
  ) +
  theme_minimal(base_size = 13)+
  theme(
    panel.grid.major.x = element_blank(),
    panel.grid.minor = element_blank(),
    axis.text.x = element_text(face = "bold")
  )
plot_codes

```

